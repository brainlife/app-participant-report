import{d as e,P as t,c as s,a as r,F as i,r as o,b as a,o as n,n as l,e as c,t as h,w as u,v as d,p as m,f,S as p,W as g,g as v,h as y,R as w,B as b,i as k,j as _,k as x,T as M,O as S,L as C,l as L,m as A,A as E,q as P,s as V,V as T,M as R,C as $,u as j,x as U,y as z,z as W,D as B,E as I,G as F,H as O,I as G,J as D,K as N,N as q}from"./vendor.3bdcd755.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var H=e({props:{surfaces:{type:Object,required:!0}},mounted(){new t(this.$refs.surfaces)},methods:{color:e=>e.left?e.left.color.getStyle():e.right?e.right.color.getStyle():void 0,menuitementer(e){this.$emit("menuitementer",e)},menuitemleave(e){this.$emit("menuitemleave",e)},check(e,t){e&&(t?e.left&&e.left.mesh&&(e.left.mesh.visible=e.left_check):e.right&&e.right.mesh&&(e.right.mesh.visible=e.right_check),this.$emit("update"))}}});const K={class:"controls"},J=r("div",{class:"control-row",style:{margin:"8px 0px",position:"relative"}},[r("b",{class:"check check-left"}," L "),r("b",{class:"check check-right"}," R "),r("h2",null,"Brain Regions")],-1),X={class:"scrollable",ref:"surfaces"},Y={key:0},Z=["onMouseenter","onMouseleave"],Q=["onChange","onUpdate:modelValue"],ee=["onChange","onUpdate:modelValue"],te=r("br",null,null,-1);H.render=function(e,t,m,f,p,g){return n(),s("div",K,[J,r("div",X,[e.surfaces?(n(),s("div",Y,[(n(!0),s(i,null,o(Object.keys(e.surfaces),(t=>{var r,i;return n(),s("div",{key:t,style:l({color:e.color(e.surfaces[t])}),class:"control-row",onMouseenter:s=>e.menuitementer(e.surfaces[t]),onMouseleave:s=>e.menuitemleave(e.surfaces[t])},[c(h(t)+" ",1),(null==(r=e.surfaces[t].left)?void 0:r.mesh)?u((n(),s("input",{key:0,type:"checkbox",class:"check check-left",onChange:s=>e.check(e.surfaces[t],!0),"onUpdate:modelValue":s=>e.surfaces[t].left_check=s},null,40,Q)),[[d,e.surfaces[t].left_check]]):a("",!0),(null==(i=e.surfaces[t].right)?void 0:i.mesh)?u((n(),s("input",{key:1,type:"checkbox",class:"check check-right",onChange:s=>e.check(e.surfaces[t],!1),"onUpdate:modelValue":s=>e.surfaces[t].right_check=s},null,40,ee)),[[d,e.surfaces[t].right_check]]):a("",!0)],44,Z)})),128))])):a("",!0)],512),te])};var se=e({props:{tracts:{type:Object,required:!0}},data:()=>({all_left:!1,all_right:!1}),computed:{sorted_tracts:function(){return this.tracts?Object.keys(this.tracts).sort():[]}},mounted(){new t(this.$refs.tracts)},watch:{all_left:function(e){var t;for(let s in this.tracts){let r=this.tracts[s];(null==(t=r.left)?void 0:t.mesh)&&(r.left_check=e,r.left.mesh.visible=e)}this.$emit("update")},all_right:function(e){var t;for(let s in this.tracts){let r=this.tracts[s];(null==(t=r.right)?void 0:t.mesh)&&(r.right_check=e,r.right.mesh.visible=e)}this.$emit("update")}},methods:{color:e=>e.left?e.left.color.getStyle():e.right?e.right.color.getStyle():void 0,menuitementer(e){this.$emit("menuitementer",e)},menuitemleave(e){this.$emit("menuitemleave",e)},check(e,t){var s,r;e&&(t?(null==(s=e.left)?void 0:s.mesh)&&(e.left.mesh.visible=e.left_check):(null==(r=e.right)?void 0:r.mesh)&&(e.right.mesh.visible=e.right_check),this.$emit("update"))}}});m("data-v-eb595be8");const re={class:"controls"},ie=r("div",{class:"control-row",style:{margin:"8px 0px",position:"relative"}},[r("b",{class:"check check-left"}," L "),r("b",{class:"check check-right"}," R "),r("h2",null,"White Matter Tracts")],-1),oe={class:"scrollable",ref:"tracts"},ae={key:0},ne={class:"control-row",style:{"border-bottom":"1px solid #fff3","padding-bottom":"5px","margin-bottom":"5px"}},le=r("b",{style:{opacity:"0.3",position:"relative"}},"All",-1),ce=["onMouseenter","onMouseleave"],he=["onChange","onUpdate:modelValue"],ue=["onChange","onUpdate:modelValue"];f(),se.render=function(e,t,m,f,p,g){return n(),s("div",re,[ie,r("div",oe,[e.tracts?(n(),s("div",ae,[r("div",ne,[le,u(r("input",{type:"checkbox","onUpdate:modelValue":t[0]||(t[0]=t=>e.all_left=t),class:"check check-left"},null,512),[[d,e.all_left]]),u(r("input",{type:"checkbox","onUpdate:modelValue":t[1]||(t[1]=t=>e.all_right=t),class:"check check-right"},null,512),[[d,e.all_right]])]),(n(!0),s(i,null,o(e.sorted_tracts,(t=>{var r,i;return n(),s("div",{key:t,style:l([{color:e.color(e.tracts[t])},{position:"relative"}]),class:"control-row",onMouseenter:s=>e.menuitementer(e.tracts[t]),onMouseleave:s=>e.menuitemleave(e.tracts[t])},[c(h(t)+" ",1),(null==(r=e.tracts[t].left)?void 0:r.mesh)?u((n(),s("input",{key:0,type:"checkbox",class:"check check-left",onChange:s=>e.check(e.tracts[t],!0),"onUpdate:modelValue":s=>e.tracts[t].left_check=s},null,40,he)),[[d,e.tracts[t].left_check]]):a("",!0),(null==(i=e.tracts[t].right)?void 0:i.mesh)?u((n(),s("input",{key:1,type:"checkbox",class:"check check-right",onChange:s=>e.check(e.tracts[t],!1),"onUpdate:modelValue":s=>e.tracts[t].right_check=s},null,40,ue)),[[d,e.tracts[t].right_check]]):a("",!0)],44,ce)})),128))])):a("",!0)],512)])},se.__scopeId="data-v-eb595be8";const de={scene:new p,renderer:new g({alpha:!0,antialias:!0}),camera:new v(45,2,1,5e3),camera_light:new y(16772829,.7),raycaster:new w};var me=e({data:()=>({config:{tracts:null,surfaces:null,debug:!1},controls:{orbit:null,showStart:!1,showEnd:!1},tracts:{},surfaces:{},load_percentage:1,loading:null,pushed_surface:null,hoveredLR:null,tooltip:"",tooltipBounce:null,stats:null}),mounted(){let e=window.parent.config||window.config;if(e){e.tracts&&!Array.isArray(e.tracts)&&(e.tracts=[e.tracts]),e.surfaces&&!Array.isArray(e.surfaces)&&(e.surfaces=[e.surfaces]),this.config.tracts=e.tracts,this.config.surfaces=e.surfaces;let t=localStorage.getItem("jwt");t&&this.config.tracts&&this.config.tracts.forEach((e=>{e.url+="?at="+t})),t&&this.config.surfaces&&this.config.surfaces.forEach((e=>{e.url+="?at="+t})),this.$nextTick((()=>{this.init()}))}else this.loadDemoConfig()},destroyed(){window.removeEventListener("resize",this.resize)},watch:{"controls.showStart":function(){this.updateVisibility()},"controls.showEnd":function(){this.updateVisibility()}},methods:{async init(){b.prototype.computeBoundsTree=k,b.prototype.disposeBoundsTree=_,j.prototype.raycast=I,this.config.debug&&(this.stats=new x,this.stats.dom.style.top="inherit",this.stats.dom.style.bottom="0px",this.stats.dom.style.left="inherit",this.stats.dom.style.right="0px",document.body.appendChild(this.stats.dom),this.stats.showPanel(0)),this.normalizeColor(),this.organizeLR(),this.initScene(),await Promise.all([this.loadTracts(),this.loadSurfaces()]),this.loading=null,this.load_percentage=1},async loadTracts(){if(!this.config.tracts)return;const e=(new M).load("point.png");let t=0,s=new S;de.scene.add(s);for(const r of this.config.tracts){this.loading=r.name,this.load_percentage=t++/this.config.tracts.length;const{lineGeometry:i,startPointGeometry:o,endPointGeometry:a}=await this.loadTract(r);let n=new C({color:r.color,transparent:!0,linewidth:1,opacity:.6}),l=new C({color:"white",transparent:!0,linewidth:1,opacity:.5});const c=new L(i,n);r.mesh=c,r.normal_material=n,r.highlight_material=l,c.name=r.name,c.visible=!1,c.rotation.x=-Math.PI/2,s.add(c);const h=new A({size:2,opacity:.5,map:e,blending:E,depthTest:!1,transparent:!0});h.color.setHSL(.5,.5,.3);const u=new P(o,h);u.visible=!1,u.rotation.x=-Math.PI/2,s.add(u),r.start=u;const d=new A({size:2,opacity:.5,map:e,blending:E,depthTest:!1,transparent:!0});d.color.setHSL(0,.5,.3);const m=new P(a,d);m.visible=!1,m.rotation.x=-Math.PI/2,s.add(m),r.end=m}},loadTract(e){return new Promise(((t,s)=>{e.url&&fetch(e.url).then((e=>e.json())).then((e=>{this.$worker.run((e=>{let t=e.coords;1==t.length&&3==t[0][0].length&&(t=t[0]);const s=[],r=[],i=[];return t.forEach((e=>{1==e.length&&3==e[0].length&&(e=e[0]);var t=e[0],o=e[1],a=e[2];const n=t.length;r.push(t[0],o[0],a[0]),i.push(t[n-1],o[n-1],a[n-1]);for(var l=1;l<t.length;++l)s.push(t[l-1]),s.push(o[l-1]),s.push(a[l-1]),s.push(t[l]),s.push(o[l]),s.push(a[l])})),{lines:new Float32Array(s),startPoints:new Float32Array(r),endPoints:new Float32Array(i)}}),[e]).then((e=>{let{lines:s,startPoints:r,endPoints:i}=e;const o=new b;o.setAttribute("position",new V(s,3));const a=new b;a.setAttribute("position",new V(r,3));const n=new b;n.setAttribute("position",new V(i,3)),t({lineGeometry:o,startPointGeometry:a,endPointGeometry:n})}))}))}))},async loadSurfaces(){if(!this.config.surfaces)return;let e=0,t=new T;for(const r of this.config.surfaces)if(r.url){this.loading=r.name,this.load_percentage=e++/this.config.surfaces.length;try{const e=await t.loadAsync(r.url);if(e.computeVertexNormals(),e.computeBoundsTree&&e.computeBoundsTree(),r.name.toLowerCase().includes("cerebral")){let t=new R({color:new $(0,0,0),transparent:!0,opacity:.2,depthTest:!1}),s=new j(e,t);s.rotation.x=-Math.PI/2,s.renderOrder=-1,de.scene.add(s)}let s=new j(e);s.rotation.x=-Math.PI/2,s.visible=!1,r.mesh=s,r.normal_material=new R({color:new $(r.color),transparent:!0,opacity:.8}),r.highlight_material=new U({color:new $(r.color).multiplyScalar(1.25),transparent:!0}),r.xray_material=new R({color:new $(r.color).multiplyScalar(1.25),transparent:!0,opacity:.2,depthTest:!1}),s.material=r.normal_material,de.scene.add(s)}catch(s){console.error("failed to load surface",r.url),console.error(s)}}},loadDemoConfig(){let e="/ui/tractview/testdata/0001";this.config.debug&&(e="testdata/tractseg"),console.log("loading demo tracts.json from",e+"/tracts/tracts.json"),fetch(e+"/tracts/tracts.json").then((e=>e.json())).then((t=>{Array.isArray(t)||(t=[t]),this.config.tracts=t,this.config.tracts&&this.config.tracts.forEach((t=>{t.url=e+"/tracts/"+t.filename})),fetch(e+"/surfaces/index.json").then((e=>e.json())).then((t=>{Array.isArray(t)||(t=[t]),this.config.surfaces=t,this.config.surfaces&&this.config.surfaces.forEach((t=>{t.url=e+"/surfaces/"+t.filename})),this.init()})).catch((e=>{console.error(e),this.init()}))}))},normalizeColor(){this.config.tracts&&this.config.tracts.forEach((e=>{e.color=new $(e.color[0]/2+.5,e.color[1]/2+.5,e.color[2]/2+.5)})),this.config.surfaces&&this.config.surfaces.forEach((e=>{Array.isArray(e.color)?e.color=new $(e.color[0]/2+.5,e.color[1]/2+.5,e.color[2]/2+.5):e.color=new $(e.color.r/512+.5,e.color.g/512+.5,e.color.b/512+.5)}))},organizeLR(){this.tracts={},this.config.tracts&&this.config.tracts.forEach((e=>{let t=!1,s=!1,r=e.name.toLowerCase();r.startsWith("left")&&(t=!0,r=e.name.substring(4)),r.endsWith(" l")&&(t=!0,r=e.name.substring(0,r.length-2)),r.startsWith("right")&&(s=!0,r=e.name.substring(5)),r.endsWith(" r")&&(s=!0,r=e.name.substring(0,r.length-2)),t||s||(t=!0),this.tracts[r]||(this.tracts[r]={left_check:!1,right_check:!1}),t&&(this.tracts[r].left=e),s&&(this.tracts[r].right=e)})),this.surfaces={},this.config.surfaces&&this.config.surfaces.forEach((e=>{let t=!1,s=!1,r=e.name.toLowerCase();r.startsWith("left-")&&(t=!0,r=e.name.substring(5)),r.endsWith("_left")&&(t=!0,r=e.name.substring(0,r.length-5)),r.startsWith("l-")&&(t=!0,r=e.name.substring(2)),r.startsWith("right-")&&(s=!0,r=e.name.substring(6)),r.endsWith("_right")&&(s=!0,r=e.name.substring(0,r.length-6)),r.startsWith("r-")&&(s=!0,r=e.name.substring(2)),r.includes("-lh-")&&(t=!0,r=e.name.replace("-lh-","-")),r.includes("-rh-")&&(s=!0,r=e.name.replace("-rh-","-")),r.includes("_lh_")&&(t=!0,r=e.name.replace("_lh_","-")),r.includes("_rh_")&&(s=!0,r=e.name.replace("_rh_","-")),t||s||(t=!0),this.surfaces[r]||(this.surfaces[r]={left_check:!1,right_check:!1}),t&&(this.surfaces[r].left=e),s&&(this.surfaces[r].right=e)}))},initScene(){let e=this.$refs.view.getBoundingClientRect();de.renderer.autoClear=!1,de.renderer.setSize(e.width,e.height),this.$refs.view.appendChild(de.renderer.domElement),de.camera.position.z=200,de.scene.add(new z(8421504)),de.scene.add(de.camera_light),this.controls.orbit=new W(de.camera,de.renderer.domElement),this.controls.orbit.enableDamping=!0,this.controls.orbit.dampingFactor=.25,de.scene.add(new B(50)),window.addEventListener("resize",this.resize),this.resize(),de.renderer.setAnimationLoop(this.animate)},resize(){const e=this.$refs.view.getBoundingClientRect();de.camera.aspect=e.width/e.height,de.camera.updateProjectionMatrix(),de.renderer.setSize(e.width,e.height)},animate(){var e,t,s,r;this.stats&&this.stats.begin(),this.controls.orbit&&this.controls.orbit.update(),(null==(t=null==(e=this.hoveredLR)?void 0:e.left)?void 0:t.mesh)&&this.animateMesh(this.hoveredLR.left.mesh),(null==(r=null==(s=this.hoveredLR)?void 0:s.right)?void 0:r.mesh)&&this.animateMesh(this.hoveredLR.right.mesh),de.camera_light.position.copy(de.camera.position),de.renderer.clear(),de.renderer.render(de.scene,de.camera),this.stats&&this.stats.end()},animateMesh(e){const t=(new Date).getTime(),s=Math.cos(t/5%1e3*(2*Math.PI/1e3));e.material.opacity=Math.abs(s)/2+.1},menuitementer(e){e.left&&e.left.mesh&&(e.left.mesh.material=e.left.highlight_material,e.left.mesh.visible=!0),e.right&&e.right.mesh&&(e.right.mesh.material=e.right.highlight_material,e.right.mesh.visible=!0),this.updateVisibility(),this.hoveredLR=e},menuitemleave(e){e.left&&e.left.mesh&&(e.left.mesh.material=e.left.normal_material,e.left_check||(e.left.mesh.visible=!1)),e.right&&e.right.mesh&&(e.right.mesh.material=e.right.normal_material,e.right_check||(e.right.mesh.visible=!1)),this.updateVisibility(),this.hoveredLR=null},mouseup(){var e;(null==(e=this.pushed_surface)?void 0:e.mesh)&&(this.pushed_surface.mesh.material=this.pushed_surface.normal_material,this.pushed_surface=null),this.tooltip=""},mousedown(e){let t=this.findSurface(e);(null==t?void 0:t.mesh)&&(this.pushed_surface=t,t.mesh.material=t.xray_material)},mousemove(e){this.tooltip="",this.tooltipBounce&&clearTimeout(this.tooltipBounce),this.tooltipBounce=setTimeout((()=>{let t=this.findSurface(e);t&&(this.tooltip=t.name,this.$refs.tooltip.style.left=e.x+"px",this.$refs.tooltip.style.top=e.y-30+"px")}),300)},findSurface(e){if(!this.config.surfaces)return null;let t=new F;t.x=e.clientX/window.innerWidth*2-1,t.y=-e.clientY/window.innerHeight*2+1,de.raycaster.setFromCamera(t,de.camera);let s=de.raycaster.intersectObjects(de.scene.children);for(let r=0;r<s.length;++r){let e=s[r].object;const t=this.config.surfaces.find((t=>{var s,r;return(null==(s=t.mesh)?void 0:s.visible)&&(null==(r=t.mesh)?void 0:r.uuid)==e.uuid}));if(t)return t}return null},updateVisibility(){for(let e in this.tracts){let t=this.tracts[e];t.left&&t.left.mesh&&(t.left.start.visible=t.left.mesh.visible&&this.controls.showStart,t.left.end.visible=t.left.mesh.visible&&this.controls.showEnd),t.right&&t.right.mesh&&(t.right.start.visible=t.right.mesh.visible&&this.controls.showStart,t.right.end.visible=t.right.mesh.visible&&this.controls.showEnd)}}},components:{SurfaceController:H,TractController:se}});m("data-v-1883065e");const fe={key:0,class:"loading"},pe={key:1,class:"main"},ge={key:0,id:"loading",class:"loading"},ve=r("div",{class:"controls-help"},[r("span",null,"Rotate"),r("span",null,"Zoom"),r("span",null,"Pan"),r("br"),r("img",{src:"/ui/tractview/assets/controls.461493e5.png",style:{height:"40px"}})],-1),ye={class:"rotateControl"},we=c("   "),be=r("span",null,"Auto-Rotate",-1),ke=c("   "),_e=c("   "),xe=r("span",{style:{color:"#5cf"}},"Show Fiber Startpoint",-1),Me=c("   "),Se=c("   "),Ce=r("span",{style:{color:"#f55"}},"Show Fiber Endpoint",-1),Le=c("   ");f(),me.render=function(e,t,o,l,c,m){const f=O("SurfaceController"),p=O("TractController");return n(),s(i,null,[e.config.tracts?a("",!0):(n(),s("span",fe,"Loading Config")),e.config.tracts?(n(),s("div",pe,[u(r("div",{class:"tooltip",ref:"tooltip"},h(e.tooltip),513),[[G,e.tooltip]]),r("div",{class:"view",ref:"view",onMousedown:t[0]||(t[0]=(...t)=>e.mousedown&&e.mousedown(...t)),onMouseup:t[1]||(t[1]=(...t)=>e.mouseup&&e.mouseup(...t)),onMousemove:t[2]||(t[2]=(...t)=>e.mousemove&&e.mousemove(...t))},null,544),e.load_percentage<1?(n(),s("div",ge,"Loading... "+h(e.loading)+" ("+h(Math.round(100*e.load_percentage))+"%)",1)):a("",!0),D(f,{surfaces:e.surfaces,onMenuitementer:e.menuitementer,onMenuitemleave:e.menuitemleave,onUpdate:e.updateVisibility},null,8,["surfaces","onMenuitementer","onMenuitemleave","onUpdate"]),D(p,{tracts:e.tracts,onMenuitementer:e.menuitementer,onMenuitemleave:e.menuitemleave,onUpdate:e.updateVisibility},null,8,["tracts","onMenuitementer","onMenuitemleave","onUpdate"]),ve,r("div",ye,[e.controls.orbit?u((n(),s("input",{key:0,type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=t=>e.controls.orbit.autoRotate=t)},null,512)),[[d,e.controls.orbit.autoRotate]]):a("",!0),we,be,ke,u(r("input",{type:"checkbox","onUpdate:modelValue":t[4]||(t[4]=t=>e.controls.showStart=t)},null,512),[[d,e.controls.showStart]]),_e,xe,Me,u(r("input",{type:"checkbox","onUpdate:modelValue":t[5]||(t[5]=t=>e.controls.showEnd=t)},null,512),[[d,e.controls.showEnd]]),Se,Ce,Le])])):a("",!0)],64)},me.__scopeId="data-v-1883065e";const Ae=N(me);Ae.config.globalProperties.$worker=q,Ae.mount("#app");
//# sourceMappingURL=index.a795d4d3.js.map
